package bqfontfix;

import net.minecraft.launchwrapper.IClassTransformer;
import org.objectweb.asm.*;

public class BQPatchTextRenderer implements IClassTransformer {

    private static final String TARGET = "betterquesting/api2/client/gui/panels/content/PanelTextBox";

        @Override
            public byte[] transform(String name, String transformedName, byte[] basicClass) {
                    if (basicClass == null || !name.equals(TARGET))
                                return basicClass;

                                        try {
                                                    ClassReader cr = new ClassReader(basicClass);
                                                                ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
                                                                            ClassVisitor cv = new FixFontScale(Opcodes.ASM5, cw);
                                                                                        cr.accept(cv, ClassReader.SKIP_FRAMES);
                                                                                                    return cw.toByteArray();
                                                                                                            } catch (Throwable t) {
                                                                                                                        System.out.println("[BQFontFix] ERROR: " + t);
                                                                                                                                    return basicClass;
                                                                                                                                            }
                                                                                                                                                }

                                                                                                                                                    static class FixFontScale extends ClassVisitor {

                                                                                                                                                            public FixFontScale(int api, ClassVisitor cv) {
                                                                                                                                                                        super(api, cv);
                                                                                                                                                                                }

                                                                                                                                                                                        @Override
                                                                                                                                                                                                public MethodVisitor visitMethod(int access, String name, String desc,
                                                                                                                                                                                                                                         String signature, String[] exceptions) {
                                                                                                                                                                                                                                                     MethodVisitor mv = super.visitMethod(access, name, desc, signature, exceptions);

                                                                                                                                                                                                                                                                 if (!name.equals("drawPanel"))
                                                                                                                                                                                                                                                                                 return mv;

                                                                                                                                                                                                                                                                                             return new MethodAdapter(api, mv);
                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                         }

                                                                                                                                                                                                                                                                                                             static class MethodAdapter extends MethodVisitor {

                                                                                                                                                                                                                                                                                                                     public MethodAdapter(int api, MethodVisitor mv) {
                                                                                                                                                                                                                                                                                                                                 super(api, mv);
                                                                                                                                                                                                                                                                                                                                         }

                                                                                                                                                                                                                                                                                                                                                 @Override
                                                                                                                                                                                                                                                                                                                                                         public void visitInsn(int opcode) {

                                                                                                                                                                                                                                                                                                                                                                     // replace DRETURN (return double)
                                                                                                                                                                                                                                                                                                                                                                                 if (opcode == Opcodes.DDIV) {
                                                                                                                                                                                                                                                                                                                                                                                                 // inject rounding
                                                                                                                                                                                                                                                                                                                                                                                                                 super.visitInsn(Opcodes.DMUL);
                                                                                                                                                                                                                                                                                                                                                                                                                                 super.visitLdcInsn(new Double("10.0"));
                                                                                                                                                                                                                                                                                                                                                                                                                                                 super.visitInsn(Opcodes.DMUL);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 super.visitMethodInsn(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Opcodes.INVOKESTATIC,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "java/lang/Math",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "round",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "(F)I",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         super.visitLdcInsn(new Double("10.0"));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         super.visitInsn(Opcodes.DDIV);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 super.visitInsn(opcode);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             